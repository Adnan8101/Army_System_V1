<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="../../css/pages/login.css">
</head>
<body>
    <div class="form-container">
        <div class="form-box">
            <div class="logo-container">
                <img src="../../images/logo.png" alt="Eagle Logo" class="logo">
            </div>
            <h2>Login</h2>
            <form id="loginForm">
                <select id="loginType" name="loginType" required>
                    <option value="uid">Login with UID</option>
                    <option value="email">Login with Email</option>
                </select><br>
                <input type="text" id="loginInput" name="loginInput" placeholder="Enter UID" required><br>
                <input type="password" id="password" name="password" placeholder="Password" required><br>
                <button type="submit">Login</button>
            </form>
            <div id="loginMessage"></div>
            <div class="links">
                <a href="/forgot-password">Forgot Password</a> | <a href="/register">Create Account</a>
            </div>
        </div>
    </div>

    <!-- Popup Messages -->
    <div id="popup-success" class="popup">
        <p></p>
        <button onclick="closePopup('popup-success')">Close</button>
    </div>
    <div id="popup-error" class="popup">
        <p></p>
        <button onclick="closePopup('popup-error')">Close</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const loginTypeSelect = document.getElementById('loginType');
            const loginInput = document.getElementById('loginInput');

            loginTypeSelect.addEventListener('change', function() {
                if (this.value === 'uid') {
                    loginInput.placeholder = 'Enter UID';
                } else {
                    loginInput.placeholder = 'Enter Email';
                }
            });

            document.getElementById('loginForm').addEventListener('submit', async function(event) {
                event.preventDefault();

                const loginType = loginTypeSelect.value;
                const loginInputValue = loginInput.value;
                const password = document.getElementById('password').value;

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ loginType, loginInput: loginInputValue, password }),
                    });

                    const result = await response.json();
                    if (response.ok) {
                        showPopup('popup-success', `Login successful. Welcome, <span style="color:#ff9900;">${result.name}</span>`);
                        setTimeout(() => {
                            let redirectUrl;
                            switch (result.userType) {
                                case 'AO':
                                    redirectUrl = '/panels/officer';
                                    break;
                                case 'WM':
                                    redirectUrl = '/panels/weapon_manufacturer';
                                    break;
                                case 'WA':
                                    redirectUrl = '/panels/agency';
                                    break;
                                default:
                                    redirectUrl = '/';
                            }
                            window.location.href = redirectUrl;
                        }, 3000);
                    } else {
                        showPopup('popup-error', result.msg || 'Invalid login credentials');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showPopup('popup-error', 'An error occurred. Please try again.');
                }
            });

            function showPopup(id, message) {
                const popup = document.getElementById(id);
                popup.querySelector('p').innerHTML = message;
                popup.style.display = 'block';
            }

            function closePopup(id) {
                const popup = document.getElementById(id);
                if (popup) {
                    popup.style.display = 'none';
                }
            }

            window.closePopup = closePopup;
        });
    </script>
</body>
</html>
